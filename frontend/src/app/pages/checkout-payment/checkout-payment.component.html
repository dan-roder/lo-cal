<div class="basic-page-container checkout-review">
  <div class="basic-page-content center">
    <h1>Complete Your Order</h1>

    <div class="form-errors" *ngIf="pickupTimeError"><p>Your scheduled pickup time is no longer valid. Please <a routerLink="/checkout/review">go back</a> to choose a new time.</p></div>

    <div class="checkout-wrapper" *ngIf="!pickupTimeError">
      <div class="form-errors" *ngIf="genericOrderError"><p>We're sorry. An unknown error occurred. Please try again and if this error persists please contact us at </p></div>
      <div class="left-pane">
        <div class="step">
          <div class="inner-step-wrapper">
            <div class="step-heading" (click)="editSection(1, $event.type)" (focus)="editSection(1, $event.type)" tabindex="0">1. Contact Information</div>
            <div class="step-wrapper" [hidden]="sectionOpen !== 1">
              <form action="" class="lo-cal-form" [formGroup]="contactInfoForm">
                <div class="form-section half-and-half">
                  <div class="form-component form-component-text">
                    <label for="first-name" class="visuallyhidden">First Name</label>
                    <input type="text" name="first-name" id="first-name" formControlName="first-name" placeholder="First Name*" [ngClass]="{'has-error':!contactInfoForm.controls['first-name'].valid && submittedOnce}">
                    <div class="error-message" *ngIf="!contactInfoForm.controls['first-name'].valid && submittedOnce">This field is required.</div>
                  </div>
                  <div class="form-component form-component-text">
                    <label for="last-name" class="visuallyhidden">Last Name</label>
                    <input type="text" name="last-name" id="last-name" formControlName="last-name" placeholder="Last Name*" [ngClass]="{'has-error':!contactInfoForm.controls['last-name'].valid && submittedOnce}">
                    <div class="error-message" *ngIf="!contactInfoForm.controls['last-name'].valid && submittedOnce">This field is required.</div>
                  </div>
                </div>
                <div class="form-section half-and-half">
                  <div class="form-component form-component-email">
                    <label for="email" class="visuallyhidden">Email</label>
                    <input type="text" name="email" id="email" formControlName="email" placeholder="Email*" [ngClass]="{'has-error':!contactInfoForm.controls['email'].valid && submittedOnce}">
                    <div class="error-message" *ngIf="!contactInfoForm.controls['email'].valid && submittedOnce">This field is required.</div>
                  </div>
                  <div class="form-component form-component-text">
                    <label for="phone" class="visuallyhidden">Phone</label>
                    <input type="text" name="phone" id="phone" formControlName="phone" placeholder="Phone">
                  </div>
                </div>
                <div class="next-step black-button">
                  <button [disabled]="!contactInfoForm.valid" (click)="nextStep()">Next Step</button>
                </div>
              </form>
            </div>
          </div><!-- /. inner-step-wrapper -->
        </div><!-- /.step -->
        <div class="step">
          <div class="inner-step-wrapper">
            <div class="step-heading" (click)="editSection(2, $event.type)" (focus)="editSection(2, $event.type)" tabindex="0">2. Payment</div>
            <div class="step-wrapper" [hidden]="sectionOpen !== 2">
              <form action="" class="lo-cal-form" [formGroup]="paymentForm">
                <div class="saved-payment-wrapper">
                  <div class="radio-options flex-between saved-payment-wrapper">
                    <div class="option">
                      <label for="cc">
                        <input type="radio" name="payment-choice" id="cc" value="1" formControlName="payment-choice"  [(ngModel)]="paymentChoice">
                        <span class="semi-bold">Pay now with a credit card</span>
                      </label>
                    </div>
                    <div class="option" *ngIf="savedPaymentMethods">
                      <label for="saved-payment">
                        <input type="radio" name="payment-choice" id="saved-payment" value="3" formControlName="payment-choice" [(ngModel)]="paymentChoice">
                        <span class="semi-bold">Pay with a saved card</span>
                      </label>
                    </div>
                  </div>
                  <div class="saved-cards" *ngIf="savedPaymentMethods && paymentForm.controls['payment-choice'].value === '3'">
                    <select name="" id="" (change)="whichPayment($event.target.value)" class="custom">
                      <option [value]="savedPaymentMethods.AccountId" selected>{{ savedPaymentMethods.MaskedAccountNumber }}</option>
                    </select>
                  </div>
                </div>
                <div class="new-card-section" *ngIf="paymentForm.controls['payment-choice'].value === '1'">
                  <div class="form-section half-and-half">
                    <div class="form-component form-component-text">
                      <label for="card-number" class="visuallyhidden">Credit Card Number</label>
                      <input id="card-number" type="tel" autocomplete="cc-number" formControlName="card-number" placeholder="Credit Card Number*" [ngClass]="{'has-error':!paymentForm.controls['card-number'].valid && submittedOnce}" ccNumber #ccNumber (ngModelChange)="detectCardType(ccNumber.value)" [(ngModel)]="cardNumber">
                      <div class="card-sprite-wrapper">
                        <div class="card visa" title="Visa"></div>
                        <div class="card mastercard" title="MasterCard"></div>
                        <div class="card american-express" title="American Express"></div>
                        <div class="card discover" title="Discover"></div>
                        <div class="card diners-club" title="Diners Club"></div>
                      </div>
                      <div class="error-message" *ngIf="!paymentForm.controls['card-number'].valid && submittedOnce">This field is required.</div>
                    </div>
                    <div class="form-component form-component-text">
                      <label for="last-name" class="visuallyhidden">Expiration Date</label>
                      <input id="cc-exp-date" name="expiration-date" id="expiration-date" formControlName="expiration-date" placeholder="Expiration Date (mm/yyyy)*" [ngClass]="{'has-error':!paymentForm.controls['expiration-date'].valid && submittedOnce}" type="tel" autocomplete="cc-exp" ccExp>
                      <div class="error-message" *ngIf="!paymentForm.controls['expiration-date'].valid && submittedOnce">This field is required.</div>
                    </div>
                  </div>
                  <div class="form-section half-and-half">
                    <div class="form-component form-component-email">
                      <label for="email" class="visuallyhidden">CVV</label>
                      <input type="text" name="cvv" id="cvv" formControlName="cvv" placeholder="CVV*" [ngClass]="{'has-error':!paymentForm.controls['cvv'].valid && submittedOnce}">
                      <div class="error-message" *ngIf="!paymentForm.controls['cvv'].valid && submittedOnce">This field is required.</div>
                    </div>
                    <div class="form-component form-component-text radio-options" *ngIf="currentCustomer?.CustomerId">
                      <div class="option">
                        <label for="save-payment">
                          <input type="checkbox" name="save-payment" id="save-payment" value="save" formControlName="save-payment">
                          <span class="semi-bold">Save payment for future use?</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="next-step black-button step-4-button">
                  <button [disabled]="(!paymentForm.valid && paymentChoice !== '3')"(click)="nextStep()">Next Step</button>
                </div>
              </form>
            </div>
          </div><!-- /. inner-step-wrapper -->
        </div><!-- /.step -->
        <div class="step step-4">
          <div class="inner-step-wrapper">
            <div class="step-heading" tabindex="0">3. Place Your Order</div>
            <div class="step-wrapper">
              <p class="question semi-bold">Your total: {{ currentOrder?.TotalAmount | currency }}</p>
            </div>
            <div class="red-button small-text" [ngClass]="processing ? 'loading' : ''">
              <div class="loading-gif button-size" *ngIf="processing"></div>
              <p>{{ orderResultForTesting }}</p>
              <button [disabled]="(!pickupForm.valid || (!paymentForm.valid && (paymentChoice !== '3')) || !contactInfoForm.valid) && !processing && !pickupTimeError" *ngIf="!processing" (click)="submitOrder()" tabindex="0">Place Order Now</button>
            </div>
            <!-- <p class="terms-and-conditions small-text">
              By placing your order you agree to our Terms of Conditions. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Fusce vehicula ac orci sed venenatis. Phasellus venenatis blandit nulla non pretium. Sed id metus non nisi pulvinar dictum.
            </p> -->
          </div><!-- /. inner-step-wrapper -->
        </div><!-- /.step -->
      </div><!-- /.left-pane -->
      <div class="order-summary">
        <div class="itemized-summary">
          <h4>Order Summary</h4>
          <div class="item flex-between" *ngFor="let menuItem of orderForDisplay">
            <div class="item-specifics">
              <div class="title semi-bold"><span class="quantity">{{ menuItem?.quantity }} x</span> <span class="item-name">{{ menuItem?.name }}</span></div>
              <div class="additions" *ngIf="menuItem?.modifiers">
                <span class="modifier" *ngFor="let mod of menuItem?.modifiers; let last = last;">{{ mod?.name }}<span class="separator" *ngIf="!last">,</span></span>
              </div>
            </div>
            <div class="item-price">
              <span class="price">{{ menuItem?.fullPrice | currency }}</span>
            </div>
          </div>
        </div><!-- /.itemized-summary -->
        <div class="pricing-and-location">
          <div class="pricing-details">
            <div class="flex-between subtotal">
              <span class="label">Subtotal</span>
              <span class="value">{{ currentOrder?.SubTotalAmount | currency }}</span>
            </div>
            <div class="flex-between">
              <span class="label">Tax</span>
              <span class="value">{{ currentOrder?.TaxAmount | currency }}</span>
            </div>
            <div class="flex-between total">
              <span class="label semi-bold">Total</span>
              <span class="value semi-bold">{{ currentOrder?.TotalAmount | currency }}</span>
            </div>

            <div class="red-button full-width-button small-text" [ngClass]="processing ? 'loading' : ''">
              <div class="loading-gif button-size" *ngIf="processing"></div>
              <p>{{ orderResultForTesting }}</p>
              <button [disabled]="(!pickupForm.valid || (!paymentForm.valid && (paymentChoice !== '3')) || !contactInfoForm.valid) && !processing" *ngIf="!processing" (click)="submitOrder()">Place Order Now</button>
            </div>
            <p class="go-back text-center">
              <a href="">or go back to edit your order</a>
            </p>
          </div>
          <div class="location-details" [innerHtml]="addressData?.content?.rendered | safeHtml">
        </div><!-- /.pricing-and-location -->

      </div><!-- /.order-summary -->
    </div>

  </div><!-- /.basic-page-content -->
</div><!-- /.checkout-review -->